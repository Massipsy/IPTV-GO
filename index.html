<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مشغل IPTV احترافي</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#66fcf1">
  <link rel="icon" href="icons/icon-192.png">

  <!-- HLS -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    /* نفس التنسيق الأصلي */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #0b0c10;
      color: #fff;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: row-reverse;
      direction: rtl;
    }
    .playlist {
      width: 300px;
      background-color: #1f2833;
      overflow-y: auto;
      padding: 10px;
      border-right: 2px solid #66fcf1;
    }
    .playlist h2 {
      text-align: center;
      color: #66fcf1;
      margin-bottom: 10px;
    }
    .search-container {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
      align-items: center;
    }
    .playlist input[type="text"] {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 5px;
      background-color: #0b0c10;
      color: #fff;
      border: 1px solid #66fcf1;
    }
    .search-container button {
      background-color: #66fcf1;
      border: none;
      border-radius: 5px;
      padding: 8px;
      cursor: pointer;
      color: #0b0c10;
      font-size: 18px;
      position: relative;
    }
    .mic-loader {
      width: 14px;
      height: 14px;
      border: 2px solid brown;
      border-top: 2px solid blue;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      position: absolute;
      right: -18px;
      top: 5px;
      display: none;
    }
    .lang-toggle {
      background-color: #45a29e;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 14px;
    }
    @keyframes spin {
      0% {transform: rotate(0deg);}
      100% {transform: rotate(360deg);}
    }
    .playlist-item {
      padding: 10px;
      cursor: pointer;
      background-color: #0b0c10;
      margin-bottom: 5px;
      border-radius: 5px;
      border: 1px solid #45a29e;
    }
    .playlist-item:hover,
    .playlist-item.active {
      background-color: #45a29e;
      color: #0b0c10;
    }
    .player-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      position: relative;
    }
    .video-wrapper {
      flex: 1;
      background-color: black;
      border: 2px solid #66fcf1;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    video {
      width: 100%;
      height: 100%;
    }
    .settings-toggle {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.3);
      color: #66fcf1;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 10;
      font-size: 18px;
    }
    .settings-menu {
      position: absolute;
      top: 50px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid #66fcf1;
      border-radius: 10px;
      padding: 10px;
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 15;
      min-width: 160px;
    }
    .settings-menu button {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: transparent;
      border: none;
      color: #fff;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .settings-menu button:hover {
      background-color: rgba(102, 252, 241, 0.2);
    }
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #66fcf1;
      border-top: 2px solid #0b0c10;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 5px;
      vertical-align: middle;
    }
    @media (orientation: portrait) {
      body { flex-direction: column; }
      .playlist {
        width: 100%;
        border-right: none;
        border-top: 2px solid #66fcf1;
      }
    }
  </style>
</head>
<body>
  <div class="player-section">
    <div class="video-wrapper">
      <video id="videoPlayer" controls></video>
      <div class="settings-toggle" onclick="toggleSettingsMenu()">⚙️</div>
      <div class="settings-menu" id="settingsMenu">
        <button onclick="playPause()">▶️ تشغيل/إيقاف</button>
        <button onclick="stop()">⏹️ إيقاف</button>
        <button onclick="previousChannel()">⏮️ القناة السابقة</button>
        <button onclick="nextChannel()">⏭️ القناة التالية</button>
        <button onclick="videoPlayer.currentTime -= 10">⏪ -10 ثوان</button>
        <button onclick="videoPlayer.currentTime += 10">⏩ +10 ثوان</button>
        <button onclick="toggleFullScreen()">🔳 ملء الشاشة</button>
        <button onclick="togglePiP()">📺 صورة في صورة</button>
      </div>
    </div>
  </div>

  <div class="playlist">
    <h2>📺 قائمة القنوات</h2>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="🔍 بحث عن قناة..." oninput="filterChannels(this.value)">
      <button onclick="startVoiceSearch()">🎤<span class="mic-loader" id="micLoader"></span></button>
      <button class="lang-toggle" onclick="toggleLang()" id="langToggle">🌐 الفرنسية</button>
    </div>
    <input type="text" id="m3uUrl" placeholder="أدخل رابط M3U" />
    <button onclick="loadM3U()" id="loadBtn">تحميل القائمة <span id="loadingSpinner" class="loading-spinner" style="display:none;"></span></button>
    <div id="playlist"></div>
  </div>

<script>
  const videoPlayer = document.getElementById('videoPlayer');
  const playlist = document.getElementById('playlist');
  const m3uUrlInput = document.getElementById('m3uUrl');
  const settingsMenu = document.getElementById('settingsMenu');
  const micLoader = document.getElementById('micLoader');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const langToggle = document.getElementById('langToggle');
  let currentLang = 'fr-FR';
  let channelList = [];
  let currentIndex = -1;
  let hlsInstance = null;

  function toggleLang() {
    currentLang = currentLang === 'fr-FR' ? 'ar' : 'fr-FR';
    langToggle.textContent = currentLang === 'ar' ? '🌐 العربية' : '🌐 الفرنسية';
  }

  function toggleSettingsMenu() {
    settingsMenu.style.display = settingsMenu.style.display === 'flex' ? 'none' : 'flex';
  }

  function playPause() { videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause(); }
  function stop() { videoPlayer.pause(); videoPlayer.currentTime = 0; }
  function toggleFullScreen() { !document.fullscreenElement ? videoPlayer.requestFullscreen() : document.exitFullscreen(); }

  async function togglePiP() {
    if (!('pictureInPictureEnabled' in document)) return alert('❌ وضع صورة داخل صورة غير مدعوم.');
    try {
      if (document.pictureInPictureElement) await document.exitPictureInPicture();
      else { if (videoPlayer.paused) await videoPlayer.play(); await videoPlayer.requestPictureInPicture(); }
    } catch (e) { alert('⚠️ لم يتمكن من التفعيل: ' + e.message); }
  }

  async function loadM3U() {
    const url = m3uUrlInput.value;
    if (!url) return alert('أدخل رابط M3U');
    loadingSpinner.style.display = 'inline-block';
    try {
      const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
      const text = await res.text();
      const channels = parseM3U(text);
      displayPlaylist(channels);
      restoreLastChannel(channels);
    } catch (err) { alert('خطأ: ' + err.message); }
    finally { loadingSpinner.style.display = 'none'; }
  }

  function parseM3U(text) {
    const lines = text.split('\\n'); const channels = []; let ch = null;
    for (let line of lines) {
      line = line.trim();
      if (line.startsWith('#EXTINF')) { const m = line.match(/,(.+)/); ch = { name: m ? m[1] : 'قناة بدون اسم' }; }
      else if (line && !line.startsWith('#') && ch) { ch.url = line; channels.push(ch); ch = null; }
    }
    return channels;
  }

  function displayPlaylist(channels) {
    playlist.innerHTML = ''; channelList = channels;
    channels.forEach((ch, i) => {
      const item = document.createElement('div');
      item.className = 'playlist-item'; item.textContent = ch.name;
      item.onclick = () => playChannel(i);
      playlist.appendChild(item);
    });
  }

  function filterChannels(q) {
    playlist.querySelectorAll('.playlist-item').forEach(item => {
      item.style.display = item.textContent.toLowerCase().includes(q.toLowerCase()) ? '' : 'none';
    });
  }

  function playChannel(i) {
    if (i >= 0 && i < channelList.length) {
      currentIndex = i; const url = channelList[i].url;
      if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
      if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) videoPlayer.src = url;
      else if (Hls.isSupported()) { hlsInstance = new Hls(); hlsInstance.loadSource(url); hlsInstance.attachMedia(videoPlayer); }
      videoPlayer.play(); localStorage.setItem('lastChannelIndex', i);
      document.querySelectorAll('.playlist-item').forEach((el, idx) => el.classList.toggle('active', idx === i));
    }
  }

  function nextChannel() { if (channelList.length) playChannel((currentIndex + 1) % channelList.length); }
  function previousChannel() { if (channelList.length) playChannel((currentIndex - 1 + channelList.length) % channelList.length); }
  function restoreLastChannel(ch) { const s = parseInt(localStorage.getItem('lastChannelIndex')); if (!isNaN(s) && s < ch.length) playChannel(s); }

  // 🎤 البحث الصوتي
  function startVoiceSearch() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window))
      return alert("⚠️ البحث الصوتي غير مدعوم");
    const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    rec.lang = currentLang; rec.interimResults = false; rec.maxAlternatives = 1;
    micLoader.style.display = "inline-block";
    rec.start();
    rec.onresult = e => {
      const t = e.results[0][0].transcript;
      document.getElementById("searchInput").value = t; filterChannels(t);
    };
    rec.onerror = e => alert("❌ خطأ: " + e.error);
    rec.onend = () => micLoader.style.display = "none";
  }
</script>

<!-- تسجيل service worker الخاص بالـ PWA -->
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js")
      .then(() => console.log("✅ Service Worker مسجل"))
      .catch(err => console.log("❌ فشل التسجيل:", err));
  }
</script>
</body>
</html>
